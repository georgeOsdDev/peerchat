<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="description" content="">
<meta http-equiv=”Content-Type” content=”text/html; charset=UTF-8″ />
<title>peerchat</title>
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
</head>
<body>
<div id="loginButtons">
  <p><i class="fa fa-twitter"></i><a id="twlogin" class="authButton" href="http://127.0.0.1:8000/twlogin">Sign in with Twitter</a></p>
  <!-- TODO Change client_id dynamicaly by fs.readFile config -->
  <p><i class="fa fa-github"></i><a id="ghlogin" class="authButton" href="https://github.com/login/oauth/authorize?client_id=7c32db577ead973ce93f">Sign in with Github</a></p>
</div>
<div id="user" style="display:none;">
  <img id="avatarUrl"></img>
  <p><span id="userName"></span>_from_<span id="loginSvc"></span></p>
</div>
<video id="localVideo" style="display:none;" autoplay="true" control></video>
<video id="remoteVideo" style="display:none;" autoplay="true" control></video>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript">

// Todo : Add code about user list
//      : Add code about webRTC, remote video event handle, etc
//      : Clean up code
//      : Add style
//      : Move js/css to external file

var nwgui = require('nw.gui');
(function(GLOBAL){
  var PeerChat = {}


  var authPop, authPopNw, askUserInfoInterval, socket;

  socket = new WebSocket("ws://127.0.0.1:8000/signaling");
  socket.onopen = function(event) {
    console.log(event);
  };
  socket.onclose = function(event) {
    console.log(event);
  };
  socket.onmessage = function(event) {
    console.log(event);
    var message = event.data ? JSON.parse(event.data) : {};
    if (message.tag === "join") {
      startLocalVideo();
    }
  };

  function startLocalVideo(){
    navigator.webkitGetUserMedia(
      { audio: true, video: true },
      function(stream) {
        $("#localVideo").attr("src", window.webkitURL.createObjectURL(stream));

        // TODO : connect peer and stream
        // peer.addStream(stream)
      },
      function(err) {
          console.log("err",arguments);
      }
    );
  }

  function renderUserInfo(userName, avatarUrl, loginSvc){
    $("#userName").text(userName);
    $("#loginSvc").text(loginSvc);
    $("#avatarUrl").attr("src", avatarUrl);
    $("#user").show();
    $("#loginButtons").hide();

    // save in memory
    PeerChat.userName = userName;
    PeerChat.loginSvc = loginSvc;
  }
  function renderLoginFail(){
  }


  // Receive userInfo from auth popup via window.PostMessage
  function postMessageListner(e){
    if (!e || !e.data || e.data === "__ready__") return;
    clearInterval(askUserInfoInterval);
    authPop = null;

    var message = JSON.parse(e.data);
    if (message.error.error) {
      console.log("loginFail", message.error);
      renderLoginFail();
    } else {
      renderUserInfo(message.userName, message.avatarUrl, message.loginSvc);
      // Join signaling Server with generated hash
      socket.send(JSON.stringify({
          "tag"     :"join",
          "fromUser":message.userName,
          "loginSvc":message.loginSvc,
          "hash"    :message.hash
        })
      );
    }
    window.removeEventListener("message", postMessageListner);
  }

  $(function(){
    $(".authButton").on("click",function(e){
      e.preventDefault();
      if (authPop) return false;

      // This index.html is in "file://" protocol.
      // So receive auth information from server in http(s) protocol,
      // Create new popup window.
      var setting = [
            "menubar=no",
            "location=no",
            "resizable=yes",
            "scrollbars=yes",
            "status=yes"
          ].join(",");

      authPop = window.open(this.href, $(this).attr("id"), setting);
      // Listen popup and as nodewebkit-window
      authPopNw = nwgui.Window.get(authPop).on('loaded', function(){
        // Sometimes "Uncaught ReferenceError: require is not defined" happen.
        // https://github.com/rogerwang/node-webkit/issues/809
        this.window.require = require;
      });
      // Send ping until userInfo will returned.
      askUserInfoInterval = setInterval(function(){
        authPop.postMessage("give me userInfo","*");
        if (authPop.closed) {
          postMessageListner();
          authPop = null;
        };
      },1000);
      window.addEventListener("message", postMessageListner, false);
    });
  });

  // export for debug
  GLOBAL.PeerChat = PeerChat;
})(this);
</script>
</body>
</html>